---
title: DOS
date: 2017-01-01 09:00:00
tags: [操作系统]
---

# 简单批处理命令

`echo`
:   `echo [{on|off}] [message]`
打开/关闭回显功能，或显示消息。若没有参数，`echo`命令将显示当前回显设置。
在实际应用中会把`echo`和重定向符号（也称管道符号）结合来实现输入一些命令到特定的文件中。

`rem` 和 `::`
:   `rem message`
注释命令。关闭回显时，`rem`和`::`及其后的内容都不会显示；打开回显时，`rem`及其后的内容会显示，而`::`不会。

`pause`
:   暂停命令。运行`pause`命令时，将显示`Press any key to continue...`或`请按任意键继续...`。

`call`
:   `call [[Drive:][Path]FileName] [:label [arguments]]`
从一个批处理程序调用另一个批处理程序，并且不终止父批处理程序。`call`命令接受用作调用目标的标签。如果在脚本或批处理文件外使用Call，它将不会在命令行起作用。

`start`
:   调用外部程序，所有的 DOS 命令和命令行程序都可以由 start 命令来调用。
常用参数：

    - `MIN` 开始时窗口最小化。
    - `SEPARATE` 在分开的空间内开始 16 位 Windows 程序。
    - `HIGH` 在 HIGH 优先级类别开始应用程序。
    - `REALTIME` 在 REALTIME 优先级类别开始应用程序。
    - `WAIT` 启动应用程序并等候它结束。

    执行的应用程序是 32 位 GUI 应用程序时，CMD.EXE 不等应用程序终止就返回命令提示。如果在命令脚本内执行，该新行为则不会发生。

`goto`
:   `goto label`
`:LABEL` 表示一个标签
跳转命令。程序指针跳转到指定的标签，从标签后的第一条命令开始继续执行批处理程序。

`set`
:  显示、设置或删除临时变量（仅在当前命令行窗口有效）。

    - 显示变量：`set`或`set s`，前者显示批处理当前已定义的所有变量及其值，后者显示所有以s开头的变量及值。
    - 设值变量：`set a=abc`向变量a赋值abc。若变量a已被定义，则a的值被修改为abc；若变量a未定义，则此命令定义新的变量a，同时赋初始值abc。
    - 删除变量：`set a= `此命令可删除变量a。若变量a已被定义，则删除变量a；若a未定义，则此命令无实际意义。

    批处理中的变量不区分类型。
`set`命令具有扩展功能，如用作交互输入、字符串处理、数值计算等，属于高级命令范畴。

`setx [/m] {key} {value}` 设置非临时变量。默认是用户环境变量，`/m` 表示系统环境变量。

# 批处理符号

`@`
:   回显屏蔽，不显示`@`后面的命令。

`>` 与 `>>`
:   将输出信息重定向到指定的设备或文件。系统默认输出到显示器。
`echo abc>a.txt`将本在显示器上显示的消息abc输出到文件a.txt中，屏幕上无显示。若文件a.txt已存在，则将擦除其内容并写入消息abc；若a.txt不存在，则将新建一个a.txt文件并写入消息abc。
`echo abc>>a.txt`若a.txt已存在，则不会擦除原有内容而是在文件末尾添加消息abc；若a.txt不存在，则同上。

`<`
:   将输入信息来源重定向为指定的设备或文件。系统默认从显示器读取输入信息。

`|`
:   将管道符号`|`前面的命令的输出结果重定向输出到管道符号后面的命令中去，作为后面命令的输入。

`^`
:   转义符`^`将特殊符号转化为一般符号。特殊符号指：`|` `&` `>` `<`。

`&` `&&` `||`
:   逻辑命令符：
`&`:用来连接n个DOS命令，并把这些命令按顺序执行，不管是否有命令执行失败。
`&&`:当`&&`前面的命令成功执行时，才执行后面的命令，否则不执行。
`||`:当`||`前面的命令失败时，执行`||`后面的命令，否则不执行。
*`&&`和`||`实际上是通过判断errorlevel来实现的*

# 常用 DOS 命令

## 文件夹管理

- `cd`：显示当前目录名或改变当前目录。
- `md`：创建目录。
- `rd`：删除一个目录。
- `dir`：显示目录中的文件和子目录列表。
- `tree`：以图形的形式显示驱动器或路径的文件夹结构。
- `path`：为可执行文件显示或设置一个搜索路径。
- `copy`：复制文件和目录树。

## 文件管理

- `type`：显示文本文件的内容。
- `copy`：将一份或多份文件复制到另一个位置。
- `del`：删除一个或数个文件。
- `move`：移动文件并重命名文件和目录。（Windows XP Home Edition中没有）。
- `ren`：重命名文件。
- `replace`：替换文件。
- `attrib`：显示或更改文件属性。
- `find`：搜索字符串。
- `fc`：比较两个文件或两个文件集并显示它们之间的不同。

## 网络命令

- `ping`：进行网络连接测试、名称解析。
- `ftp`：文件传输。
- `net`：网络命令集及用户管理。
    - `net start|stop {service}` 启动/停止服务
- `telnet`：远程登陆。
- `ipconfig`：显示、修改TCP/IP设置。
- `msg`：给用户发送消息。
- `arp`：显示、修改局域网的IP地址-物理地址映射列表。

## 系统管理

- `at`：安排在特定日期和时间运行命令和程序。
- `shutdown`：立即或定时关机或重启。
- `tskill`：结束进程。
- `taskkill`：结束进程（比`tskill`高级，但Win XP Home版中无该命令。
- `tasklist`：显示进程列表（Windows XP Home Edition中没有）。
- `sc`：系统服务设置与控制。
    - `sc config {service} start=demand|auto|disabled` 手动/自动/禁用
    - `sc start|stop {service}` 启动/停止服务
- `reg`：注册表控制台工具。 
- `powercfg`：控制系统上的电源设置。

对于以上列出的所有命令，在cmd中输入`命令/？`即可查看该命令的帮助信息。

# 语句结构

## if语句（选择结构）

1. 字符串比较
if语句只能对两个字符（串）是否相同、先后顺序进行判断等。命令格式：
`IF [/i] [not] string1 compare-op string2 command1 [else command2]`
选择开关 `/i` 则不区分字符串大小写；选择 `not` 项，则对判断结果进行逻辑非。
其中，比较操作符 compare-op 有以下几类：
- `==` 等于
- `EQU` 等于
- `NEQ` 不等于
- `LSS` 小于
- `LEQ` 小于或等于
- `GTR` 大于
- `GEQ` 大于或等于

2. 存在判断
判断文件或文件夹是否存在。命令格式：
`IF [NOT] EXIST filename command1 [else command2]`
- 存在判断既可以判断文件也可以判断文件夹；
- `%0`代表当前批处理的全称（包括驱动器盘符、路径、文件名和扩展类型）；
- `%~df0`是对`%0`的修正，只保留了其驱动器盘符和路径，详情参考`for /?`；
- if语句的多行书写要求`command1`的左括号必须和`if`在同一行、`else`必须和`command1`的右括号同行、`command2`的左括号必须与`else`同行、`command1`和`command2`都可以任意多行，即`command`可以是命令集。

3. 定义判断
判断变量的是否存在，即是否已被定义。命令格式：
`IF [NOT] DEFINED variable command1 [else command2]`

4. 结果判断
判断命令执行后的返回码。命令格式：
`IF [NOT] errorlevel n command]`
DOS程序在运行完成后都有返回码（也叫错误码），如果和命令中定义的返回码`n`相符，则执行`command`。

## for语句（循环结构）

for语句有多个开关，不同开关将会实现不同功能。

1. 无开关
无开关的for语句能够在设定的范围内进行循环。命令格式：
`FOR %%variable IN (set) DO command`
其中，`%%variable`是批处理程序中的书写格式，在DOS中书写为`%variable`；`set`是需要设定的循环范围（变量集合）；`do`后面的`command`是循环所执行的命令，即循环体。

2. 开关`/L`
根据`set`里面的设置进行循环，从而实现对循环次数的直接控制。命令格式：
`FOR /L %%variable IN (start,step,end) DO command`
其中，`start`为开始计数的初始值，`step`为每次递增的值，`end`为结束值。当`end`小于`start`时，`step`需要设置为负数。`%%i`的结束值有可能不是`end`而是不大于`end`的一个数。

3. 开关`/F`
能够对字符串进行操作，也能够对命令的返回值进行操作，还可以访问硬盘上的ASCII码文件，比如txt文档等。命令格式：
`FOR /F ["options"] %%variable IN (set) DO command`
其中，`set`为`"String"`、`'command'`、`file-set`中的一个；`options`是`eol=c`、`skip=n`、`delims=xxx`、`tokens=x,y,m-n`、`usebackq`中的一个或多个的组合。各选项的意义参见`for /f`。

4. 开关`/D`或`/R`
含开关`/D`或`/R`的for语句是与目录或文件有关的命令，有时被用于通过遍历文件夹来查找一个文件或文件夹。

5. 其他
在for循环中，当一个变量被多次赋值时，`%dd%`所获取的仅仅是`dd`第一次被赋予的值。要想刷新`dd`的值，就必须先通过命令`setlocal enabledelayedexpansion`来开启延迟变量开关，然后用`!dd!`来获取`dd`的值。

# 字符串处理

1. 截取字符串
`%var:~m,n%` 截取第m+1到n+1个字符
`%var:~m` 截取第1到第m+1个字符
其中表示下标的`m` `n`可为负数。
**替换操作不会直接改变被操作的字符串，若要使生效变动，需再次对被操作字符串赋值。**

2. 替换字符串
`%var:src_part=des_part%`
**替换操作不会直接改变被操作的字符串，若要使生效变动，需再次对被操作字符串赋值。**

3. 合并字符串
`%str1%%str2%`
只需直接将字符串放在一起。

4. 扩充字符串
对表示文件路径的字符串进行特殊处理。
`~I` 删除任何引号（"），扩充`%I`
`%~fI` 将`%I`扩充到一个完全合格的路径名
`%~dI` 仅将`%I`扩充到一个驱动器号
`%~pI` 仅将`%I`扩充到一个路径
`%~nI` 仅将`%I`扩充到一个文件名
`%~xI` 仅将`%I`扩充到一个文件扩展名
`%~sI` 扩充的路径只含有短名
`%~aI` 将`%I`扩充到文件的文件属性
`%~tI` 将`%I`扩充到文件的日期/时间
`%~zI` 将`%I`扩充到文件的大小
`%~$PATH:I` 查找被列在路径环境变量PATH中的目录，并将`%I`扩充到找到的第一个完全合格的名称。如果环境变量名未被定义，或者没有找到文件，此组合键会扩充到空字符串
可以组合修饰符来得到多重结果：
`%~dpI` 仅将`%I`扩充到一个驱动器号和路径
`%~nxI` 仅将`%I`扩充到一个文件名和扩展名
`%~fsI` 仅将`%I`扩充到一个带有短名的完整路径名
`%~dp$PATH:i` 查找被列在路径环境变量PATH中的目录，并将`%I`扩充到找到的第一个驱动器号和路径。
`%~ftzaI` 将`%I`扩充到类似输出线路的DIR
以上`I`代表一个变量，该被扩充的变量需满足两个条件：
- 该字符串代表一个文件路径。
- 变量要用`%x`来表示，`x`可取`a-z A-Z 0-9`供62个字符中的任意一个。

# 数值计算

批处理只能进行整型计算，忽略浮点数的小数部分；同时数值计算的范围也受限于系统位数。命令格式：
`set /a expression`
`set`支持的运算符跟C语言中的一样，只是没有增一减一。
`set`支持的运算符及优先级排序：
`()` 分组
`!~-`一元运算符（逻辑非、按位非、取负）
`*/%` 算数运算符（乘、取商、取余）
`+-` 算数运算符（加、减）
`<<>>` 逻辑移位（左移一位、右移一位）
`&` 按位与
`^` 按位异
`|` 按位或
`= *= /= %= += -=` 赋值
`&= ^= |= <<= >>= ,` 表达式分隔符（`set`可一次处理多个表达式）
`set /a`中，直接用变量名即可取得变量的值；`set`支持八进制（数字前缀0）、十进制（数字无前缀）和十六进制（数字前缀0x），且支持不同进制之间的计算，计算及显示结果为十进制。

# 批处理概念方法

## 环境变量

系统变量由操作系统事先定义好，适用于任何批处理。要查看所有系统变量，可以在cmd窗口中输入`set`。
几个常用的系统变量：
`ComputerName` 计算机名，即右键-我的电脑-属性-计算机名-选项卡中的“完整的计算机名称”
`ComSpec` cmd.exe的完整路径名
`HomeDrive` 系统分区盘符
`Path` 可执行文件的默认搜索路径
`ProgramFiles` 系统的Program Files的路径
`Prompt` 返回当前解释程序的命令提示符设置，由 Cmd.exe 生成
`SystemDrive` 包含系统根目录的分区
`SystemRoot` 系统根目录路径
`Temp` `Tmp` 临时文件的存放目录
`UserName` 当前用户名
`UserProfile` 当前用户的配置目录
`WinDir` 操作系统路径

## 用户变量

用户变量由 `set` 命令定义，可参考 `set /?`。
**变量引用**
一般情况下可以直接用变量名操作变量，通过`%var%`或`!var!`来获取变量的值。其中，只有在for语句里面重复对同一变量多次赋值时才需要使用`!var!`，并且在使用`!var!`调用变量时，要首先“启用延迟环境变量扩充”，`setlocal enabledelayedexpansion`。启用延迟环境变量扩充后，所有的`!`都将被视为“取变量值”的特殊符号，即使用`^!`也不能输出符号“!”。若要输出“!”，需要停用延迟环境变量扩充，`setlocal disabledelayedexpansion`。

## 参数

1. 直接传递
在使用`call`命令时，不使用任何参数，在子函数或子批处理里面直接对主函数（也称父批处理）里面的变量进行修改。

2. 间接传递
在使用`call`命令时，在其后面添加参数，形如`call {[:label][ChildBatch]} Parameter1 Parameter2 ... ParameterN`。参数在子函数或子批处理里面是以%1~%9的形式表示的。 

## 返回值

有些命令在执行之后将会返回一定的错误值（errorlevel），可以通过errorlevel的值判断命令执行状况。获取返回值errorlevel的方法是，在执行命令后立马调用返回值errorlevel。
*`if errorlevel 0`和`if %errorlevel%==0`是一样的。*

## 用户交互

1. 视窗
    1. 设置窗口背景色和字体颜色。详见`color /?`。
    2. 设置窗口大小，`mode con [cols=c] [lines=n]`，cols即宽度，lines即高度。
    3. GUI交互窗口。详见`msg /?`。

2. 声音
调用vbs的方法：
`vbscript:createobject("sapi.spvoice").speak("Here are the words to say.")`
其中spvoice是支持语音合成（TTS）的核心类。

3. 控制
    1. 暂停批处理：按下键盘上的Pause键。
    2. 终止批处理：组合键Ctrl+C。

## ASCII码
暂略。


